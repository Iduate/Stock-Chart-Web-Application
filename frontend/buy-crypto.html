<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>암호화폐 구매</title>
  <link rel="stylesheet" href="css/figma-design.css" />
  <script src="js/auth-ui.js" defer></script>
  <style>
    .buy-card{max-width:720px;margin:32px auto;background:#0b1224;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:24px;color:#eaf2ff}
    .buy-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .buy-grid label{font-size:12px;color:#a8b3c7;margin-bottom:6px;display:block}
    .buy-grid input,.buy-grid select{width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:#0f1730;color:#eaf2ff}
    .buy-actions{margin-top:16px;display:flex;gap:12px}
    .error-text{color:#ff7a8a;font-size:12px;margin-top:8px}
    /* Modal iframe for embedded provider */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{width:min(1000px,95vw);height:min(700px,90vh);background:#0b1224;border:1px solid rgba(255,255,255,.12);border-radius:10px;overflow:hidden;display:flex;flex-direction:column}
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .modal-header h3{margin:0;font-size:14px;color:#eaf2ff}
    .modal-close{background:transparent;border:0;color:#a8b3c7;font-size:16px;cursor:pointer}
    .modal-body{flex:1;}
    .modal-body iframe{width:100%;height:100%;border:0;background:#0b1224}
    .hidden{display:none}
  </style>
  <script>
    async function startChangeNOW(){
      const crypto = document.getElementById('crypto').value.toUpperCase();
      const fiat = (document.getElementById('fiat').value || 'USD').toUpperCase();
      const amountRaw = document.getElementById('amount').value;
      const amount = parseFloat(amountRaw);
      const errBox = document.getElementById('buyError');
      if (errBox) errBox.textContent = '';
      if (isNaN(amount) || amount <= 0) {
        if (errBox) errBox.textContent = '올바른 금액을 입력하세요.';
        return;
      }
      const wallet = document.getElementById('wallet').value.trim();
      // Ask server to construct a ChangeNOW URL (API key kept server-side)
      let url = '';
      try {
        const res = await fetch('/api/payments/changenow/init/', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({crypto, fiat, amount, wallet_address: wallet})
        });
        const js = await res.json();
        if (res.ok && js && js.url) {
          url = js.url;
        } else {
          throw new Error(js && js.error ? js.error : '초기화 실패');
        }
      } catch (e) {
        if (errBox) errBox.textContent = '초기화 오류: ' + (e.message || e);
        return;
      }

      // Embed in modal iframe (ChangeNOW opens fine in iframe or new tab)
      const overlay = document.getElementById('cnModal');
      const frame = document.getElementById('cnFrame');
      frame.src = url;
      overlay.style.display = 'flex';
      frame.focus();
    }

    document.addEventListener('DOMContentLoaded', async function(){
      // Show provider status
      const banner = document.getElementById('statusBanner');
      try {
        const st = await fetch('/api/payments/changenow/status/');
        const js = await st.json().catch(() => ({}));
        if (banner){
          if (!st.ok || !js.configured){
            banner.textContent = '설정 필요: CHANGENOW_API_KEY 누락';
            banner.classList.add('warning');
          } else {
            banner.textContent = 'ChangeNOW 카드 구매 위젯 사용 중';
            banner.classList.add('ok');
          }
        }
      } catch {
        if (banner){
          banner.textContent = '상태 확인 실패: 서버 연결 문제';
          banner.classList.add('warning');
        }
      }

      const btn = document.getElementById('buyWithCardBtn');
      if (btn){
        btn.addEventListener('click', async function(){
          if (btn.getAttribute('data-loading') === '1') return;
          const original = btn.innerHTML;
          btn.setAttribute('data-loading', '1');
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 처리 중...';
          try {
            await startChangeNOW();
          } finally {
            btn.removeAttribute('data-loading');
            btn.disabled = false;
            btn.innerHTML = original;
          }
        });
      }
    });
  </script>
</head>
<body>
  <div class="buy-card">
    <div id="statusBanner" style="margin-bottom:8px;font-size:12px;color:#a8b3c7"></div>
    <h2>카드로 암호화폐 구매</h2>
    <p style="opacity:.8">신용/체크카드로 비트코인(BTC), 이더리움(ETH) 등을 구매할 수 있습니다.</p>

    <div class="buy-grid">
      <div>
        <label for="crypto">암호화폐</label>
        <select id="crypto">
          <option value="BTC">Bitcoin (BTC)</option>
          <option value="ETH">Ethereum (ETH)</option>
        </select>
      </div>
      <div>
        <label for="fiat">결제 통화</label>
        <select id="fiat">
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
          <option value="KRW">KRW</option>
        </select>
      </div>
      <div>
        <label for="amount">결제 금액</label>
        <input id="amount" type="number" min="20" step="1" placeholder="예: 100" />
      </div>
      <div>
  <label for="wallet">지갑 주소 (선택)</label>
  <input id="wallet" type="text" placeholder="입력하지 않으면 결제 페이지에서 입력합니다" />
      </div>
    </div>

    <div class="buy-actions">
  <button id="buyWithCardBtn" class="btn-predict"><i class="fas fa-credit-card"></i> 카드로 구매하기</button>
      <a class="btn-secondary" href="/index.html">돌아가기</a>
    </div>

    <div id="buyError" class="error-text" role="alert" aria-live="polite"></div>

    <p style="margin-top:10px;color:#a8b3c7;font-size:12px">고지: 구매는 제3자 제공업체(ChangeNOW)에서 처리되며, 제공업체 정책에 따라 KYC가 필요할 수 있습니다.</p>
  </div>

  <!-- Embedded ChangeNOW modal -->
  <div id="cnModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="cnTitle">
    <div class="modal">
      <div class="modal-header">
        <h3 id="cnTitle">ChangeNOW 결제</h3>
        <button class="modal-close" id="cnClose" aria-label="닫기">✕</button>
      </div>
      <div class="modal-body">
        <iframe id="cnFrame" title="ChangeNOW Checkout" referrerpolicy="no-referrer"></iframe>
      </div>
    </div>
  </div>

  <script>
    // Close modal handlers
    (function(){
      const overlay = document.getElementById('cnModal');
      const closeBtn = document.getElementById('cnClose');
      function close(){ overlay.style.display='none'; const f=document.getElementById('cnFrame'); if (f) f.src='about:blank'; }
      closeBtn?.addEventListener('click', close);
      overlay?.addEventListener('click', (e)=>{ if (e.target===overlay) close(); });
      window.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && overlay && overlay.style.display==='flex') close(); });
    })();
  </script>

  <script src="https://kit.fontawesome.com/a2e0e6ad65.js" crossorigin="anonymous"></script>
</body>
</html>