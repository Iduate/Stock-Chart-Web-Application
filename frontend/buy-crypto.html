<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>암호화폐 구매</title>
  <link rel="stylesheet" href="css/figma-design.css" />
  <script src="js/auth-ui.js" defer></script>
  <style>
    .buy-card{max-width:720px;margin:32px auto;background:#0b1224;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:24px;color:#eaf2ff}
    .buy-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .buy-grid label{font-size:12px;color:#a8b3c7;margin-bottom:6px;display:block}
    .buy-grid input,.buy-grid select{width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:#0f1730;color:#eaf2ff}
    .buy-actions{margin-top:16px;display:flex;gap:12px}
    .error-text{color:#ff7a8a;font-size:12px;margin-top:8px}
  </style>
  <script>
    async function getAccessTokenFromCookies() {
      const m = document.cookie.match(/(?:^|;\s*)sc_access=([^;]+)/);
      return m ? decodeURIComponent(m[1]) : null;
    }

    async function ensureAuth() {
      const ls = localStorage.getItem('access_token');
      const cookieToken = await getAccessTokenFromCookies();
      return ls || cookieToken;
    }

    async function startMoonPay(){
      const access = await ensureAuth();
      // Check MoonPay status before trying
      try{
        const st = await fetch('/api/payments/onramp/moonpay/status/');
        const stJson = await st.json().catch(() => ({}));
        if (!st.ok || !stJson.configured){
          alert('코인 결제 설정이 아직 완료되지 않았습니다. 관리자에게 문의해주세요.');
          return;
        }
      }catch{
        // non-fatal; continue
      }

      const crypto = document.getElementById('crypto').value.toUpperCase();
      const fiat = (document.getElementById('fiat').value || 'USD').toUpperCase();
      const amountRaw = document.getElementById('amount').value;
      const amount = parseFloat(amountRaw);
      if (isNaN(amount) || amount <= 0) {
        const errBox = document.getElementById('buyError');
        if (errBox) errBox.textContent = '올바른 금액을 입력하세요.';
        return;
      }
      const wallet = document.getElementById('wallet').value.trim();
      const body = { crypto, fiat, amount, wallet_address: wallet || undefined };
      const errBox = document.getElementById('buyError');
      if (errBox) errBox.textContent='';
      try{
        // First check availability for the chosen region/amount to avoid 'coming soon' page
        try{
          const availability = await fetch(`/api/payments/onramp/moonpay/available/?crypto=${encodeURIComponent(crypto)}&fiat=${encodeURIComponent(fiat)}&amount=${encodeURIComponent(amount)}`);
          const availJson = await availability.json().catch(() => ({}));
          if (!availability.ok || !availJson.available){
            const errBox = document.getElementById('buyError');
            let message = availJson.body || availJson.reason || availJson.error || '이 지역에서는 현재 지원하지 않습니다.';
            // If MoonPay provides structured info, show friendly instruction
            if (availJson.moonpay){
              const mp = availJson.moonpay;
              if (mp.moonPayErrorCode || mp.message){
                message = `MoonPay: ${mp.moonPayErrorCode || ''} ${mp.message || ''}`.trim();
              }
              // If on-ramp disabled in live, prompt to use sandbox or contact support
              if (mp.message && mp.message.includes('On-Ramp is not yet enabled')){
                message += ' — 실시간 온램프가 활성화되어 있지 않습니다. Sandbox 테스트를 사용하거나 MoonPay 지원(team@moonpay.com)으로 연락하세요.';
              }
            }
            if (errBox) errBox.textContent = '지원 불가: ' + message;
            return;
          }
        }catch(e){
          // if the availability call fails, continue and let the main call handle errors
          console.warn('Availability check failed, proceeding to init', e);
        }

        const res = await fetch('/api/payments/onramp/moonpay/init/',{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            ...(access ? { 'Authorization': 'Bearer '+access } : {})
          },
          body: JSON.stringify(body)
        });
        let data = {};
        try { data = await res.json(); } catch (e) { data = {}; }
        if(!res.ok || !data.url){
          // Try to extract text error for better visibility
          let textMsg = '';
          try { textMsg = await res.text(); } catch {}
          const msg = data.error || data.detail || textMsg || '요청 실패';
          if (errBox) errBox.textContent = '오류: ' + msg;
          throw new Error(msg);
        }
        window.location.href = data.url;
      }catch(e){
        console.error(e);
        if (!document.getElementById('buyError')){
          alert('구매 시작 중 오류가 발생했습니다: ' + e.message);
        }
      }
    }
    // simple success/cancel markers
    document.addEventListener('DOMContentLoaded', async function(){
      try{
        const st = await fetch('/api/payments/onramp/moonpay/status/');
        const stJson = await st.json().catch(() => ({}));
        const banner = document.getElementById('statusBanner');
        if (banner){
          if (!st.ok){
            banner.textContent = '상태 확인 실패: 서버 연결 문제';
            banner.classList.add('warning');
          } else if (!stJson.configured){
            banner.textContent = '관리자 설정 필요: MOONPAY_API_KEY / SECRET이 비어 있습니다 (샌드박스='+(stJson.sandbox?'예':'아니오')+', 키 모드='+(stJson.key_mode||'unknown')+')';
            banner.classList.add('warning');
          } else {
            banner.textContent = '코인 결제를 사용할 수 있습니다'+(stJson.sandbox?' (샌드박스)':' (라이브)');
            banner.classList.add('ok');
          }
        }
      }catch{}

      if (location.pathname.endsWith('/payment-success.html')){
        alert('결제가 완료되었을 수 있습니다. MoonPay 영수증을 확인해주세요.');
      } else if (location.pathname.endsWith('/payment-cancel.html')){
        alert('결제가 취소되었습니다.');
      }
    });
    // Bind click handler without inline attribute (CSP safe)
    document.addEventListener('DOMContentLoaded', function(){
      const btn = document.getElementById('buyWithCardBtn');
      if (btn){
        btn.addEventListener('click', async function(){
          // simple loading guard
          if (btn.getAttribute('data-loading') === '1') return;
          const original = btn.innerHTML;
          btn.setAttribute('data-loading', '1');
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 처리 중...';
          try {
            await startMoonPay();
          } finally {
            btn.removeAttribute('data-loading');
            btn.disabled = false;
            btn.innerHTML = original;
          }
        });
      }
    });
  </script>
</head>
<body>
  <div class="buy-card">
    <div id="statusBanner" style="margin-bottom:8px;font-size:12px;color:#a8b3c7"></div>
    <h2>카드로 암호화폐 구매</h2>
    <p style="opacity:.8">신용/체크카드로 비트코인(BTC), 이더리움(ETH) 등을 구매할 수 있습니다.</p>

    <div class="buy-grid">
      <div>
        <label for="crypto">암호화폐</label>
        <select id="crypto">
          <option value="BTC">Bitcoin (BTC)</option>
          <option value="ETH">Ethereum (ETH)</option>
        </select>
      </div>
      <div>
        <label for="fiat">결제 통화</label>
        <select id="fiat">
                  if (availJson.switch_to_sandbox){
                    message += ' (힌트: 서버를 샌드박스 모드로 전환하세요)';
                  }
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
          <option value="KRW">KRW</option>
        </select>
      </div>
      <div>
        <label for="amount">결제 금액</label>
        <input id="amount" type="number" min="20" step="1" placeholder="예: 100" />
      </div>
      <div>
        <label for="wallet">지갑 주소 (선택)</label>
        <input id="wallet" type="text" placeholder="입력하지 않으면 MoonPay에서 입력합니다" />
      </div>
    </div>

    <div class="buy-actions">
  <button id="buyWithCardBtn" class="btn-predict"><i class="fas fa-credit-card"></i> 카드로 구매하기</button>
      <a class="btn-secondary" href="/index.html">돌아가기</a>
    </div>

    <div id="buyError" class="error-text" role="alert" aria-live="polite"></div>

    <p style="margin-top:10px;color:#a8b3c7;font-size:12px">고지: 구매는 제3자 제공업체(MoonPay)를 통해 처리되며, KYC가 필요할 수 있습니다.</p>
  </div>

  <script src="https://kit.fontawesome.com/a2e0e6ad65.js" crossorigin="anonymous"></script>
</body>
</html>