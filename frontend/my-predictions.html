<!DOCTYPE html>
<html lang="ko" class="h-full">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>내 예측 - StockChart</title>
	<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📈</text></svg>">

	<!-- Core Styles -->
	<link rel="stylesheet" href="css/figma-design.css">
	<link rel="stylesheet" href="css/mobile-trading.css">

	<!-- Fonts & Icons -->
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

	<!-- Charts -->
	<script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body class="home-body">
	<div class="home-desktop desktop-only">
		<header class="dashboard-top-bar">
			<div class="top-brand">
				<div class="brand-icon">
					<i class="fas fa-user-chart"></i>
				</div>
				<div>
					<p class="brand-eyebrow">개인 투자 성과</p>
					<h1 class="brand-title">내 예측 보드</h1>
				</div>
			</div>
			<nav class="top-nav-links">
				<a href="index.html" class="top-nav-link">
					<i class="fas fa-home"></i>
					<span>홈</span>
				</a>
				<a href="charts.html" class="top-nav-link">
					<i class="fas fa-chart-area"></i>
					<span>차트</span>
				</a>
				<a href="prediction.html" class="top-nav-link">
					<i class="fas fa-magic"></i>
					<span>예측하기</span>
				</a>
				<a href="my-predictions.html" class="top-nav-link active">
					<i class="fas fa-user-chart"></i>
					<span>내 예측</span>
				</a>
				<a href="ranking.html" class="top-nav-link">
					<i class="fas fa-trophy"></i>
					<span>랭킹</span>
				</a>
				<a href="events.html" class="top-nav-link">
					<i class="fas fa-calendar-star"></i>
					<span>이벤트</span>
				</a>
			</nav>
			<div class="top-actions">
				<button id="refreshPredictionsBtn" class="ghost-btn">
					<i class="fas fa-rotate"></i>
					새로고침
				</button>
				<button id="newPredictionBtn" class="primary-btn">
					<i class="fas fa-plus"></i>
					새 예측 작성
				</button>
			</div>
		</header>

		<section class="home-dashboard predictions-dashboard">
			<div id="statsOverview" class="home-metrics"></div>

			<div class="home-main-grid predictions-grid">
				<div class="predictions-table-card">
					<div class="card-heading">
						<div>
							<h2>예측 내역</h2>
							<p>제출한 예측들의 진행 상황을 추적하세요.</p>
						</div>
						<div class="heading-actions">
							<button id="testDataBtn" class="ghost-btn">
								<i class="fas fa-flask"></i>
								테스트 데이터
							</button>
						</div>
					</div>

					<div class="predictions-filters">
						<div class="filter-group">
							<label for="statusFilter">상태</label>
							<select id="statusFilter" class="filter-select">
								<option value="all">전체</option>
								<option value="pending">진행중</option>
								<option value="completed">완료</option>
								<option value="cancelled">취소됨</option>
							</select>
						</div>
						<div class="filter-group">
							<label for="periodFilter">기간</label>
							<select id="periodFilter" class="filter-select">
								<option value="all">전체</option>
								<option value="week">이번 주</option>
								<option value="month">이번 달</option>
								<option value="quarter">최근 3개월</option>
							</select>
						</div>
						<div class="filter-group">
							<label for="symbolFilter">종목</label>
							<select id="symbolFilter" class="filter-select">
								<option value="all">전체</option>
								<option value="crypto">암호화폐</option>
								<option value="us_stock">미국 주식</option>
								<option value="kr_stock">국내 주식</option>
							</select>
						</div>
					</div>

					<div class="predictions-table-wrapper">
						<table class="predictions-table">
							<thead>
								<tr>
									<th>종목</th>
									<th>예측일</th>
									<th>기준가</th>
									<th>예측가</th>
									<th>변동률</th>
									<th>목표일</th>
									<th>상태</th>
									<th>동작</th>
								</tr>
							</thead>
							<tbody id="predictionsTableBody"></tbody>
						</table>
						<div id="predictionsLoading" class="predictions-loading hidden">
							<i class="fas fa-spinner fa-spin"></i>
							데이터를 불러오는 중입니다...
						</div>
						<div id="emptyState" class="predictions-empty hidden">
							<div class="empty-icon">
								<i class="fas fa-user-clock"></i>
							</div>
							<h3>등록된 예측이 없습니다</h3>
							<p>첫 번째 예측을 등록하고 실시간 성과를 확인해보세요.</p>
							<button class="primary-btn" id="emptyStateAction">
								<i class="fas fa-pen"></i>
								예측 만들기
							</button>
						</div>
					</div>
				</div>

				<aside class="home-order-card predictions-form-card">
					<div class="order-header">
						<h3>빠른 예측 등록</h3>
						<span>데이터 기반 추천을 활용해 빠르게 제출하세요.</span>
					</div>
					<form class="order-form" id="quickPredictionForm">
						<label class="order-label" for="quickAsset">자산 선택</label>
						<select id="quickAsset" class="order-input">
							<option value="BTC" selected>BTC / USD</option>
							<option value="ETH">ETH / USD</option>
							<option value="KOSPI">KOSPI 200</option>
							<option value="AAPL">AAPL</option>
						</select>

						<label class="order-label">방향</label>
						<div class="direction-toggle">
							<button type="button" class="direction-btn active" data-direction="up">
								<i class="fas fa-arrow-trend-up"></i>
								상승
							</button>
							<button type="button" class="direction-btn" data-direction="down">
								<i class="fas fa-arrow-trend-down"></i>
								하락
							</button>
						</div>

						<label class="order-label" for="quickTarget">목표 가격</label>
						<div class="order-input-group">
							<span>₩</span>
							<input id="quickTarget" class="order-input" type="number" placeholder="43,500,000">
						</div>

						<label class="order-label" for="quickPeriod">예측 기간</label>
						<select id="quickPeriod" class="order-input">
							<option value="1D">1일</option>
							<option value="3D">3일</option>
							<option value="1W" selected>1주일</option>
							<option value="1M">1개월</option>
						</select>

						<button type="submit" class="order-submit">
							<i class="fas fa-meteor"></i>
							예측 제출
						</button>
					</form>
					<div class="order-footnote">
						<p><i class="fas fa-shield-alt"></i> 제출된 예측은 대시보드와 랭킹에 즉시 반영됩니다.</p>
						<p><i class="fas fa-clock"></i> 평균 검증 시간 2분 미만 · 신뢰도 지수 94%</p>
					</div>
				</aside>
			</div>

			<div class="home-bottom-grid">
				<div class="home-prediction-board">
					<div class="board-header">
						<div>
							<h3>최근 예측 활동</h3>
							<span>자동 분석으로 선별된 성과 하이라이트</span>
						</div>
						<button class="board-action" id="exportPredictionsBtn">데이터 내보내기</button>
					</div>
					<table class="board-table" id="summaryBoard">
						<thead>
							<tr>
								<th>사용자</th>
								<th>예측</th>
								<th>기간</th>
								<th>결과</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>
									<div class="board-user">
										<span class="avatar">MJ</span>
										<div>
											<span class="board-name">마켓저니</span>
											<span class="board-meta">프리미엄</span>
										</div>
									</div>
								</td>
								<td>BTC / USD</td>
								<td>3일</td>
								<td class="positive">+5.2%</td>
							</tr>
							<tr>
								<td>
									<div class="board-user">
										<span class="avatar">SK</span>
										<div>
											<span class="board-name">스윙킹</span>
											<span class="board-meta">챌린지</span>
										</div>
									</div>
								</td>
								<td>KOSPI 200</td>
								<td>1주</td>
								<td class="negative">-1.8%</td>
							</tr>
							<tr>
								<td>
									<div class="board-user">
										<span class="avatar">IN</span>
										<div>
											<span class="board-name">Insight Rocket</span>
											<span class="board-meta">자동 추천</span>
										</div>
									</div>
								</td>
								<td>ETH / USD</td>
								<td>5일</td>
								<td class="positive">+3.9%</td>
							</tr>
						</tbody>
					</table>
				</div>
				<div class="home-news-card">
					<div class="board-header">
						<div>
							<h3>시장 알림 & 뉴스</h3>
							<span>포지션 유지와 리밸런싱에 참고하세요.</span>
						</div>
						<button class="board-action" id="refreshNewsBtn">업데이트</button>
					</div>
					<ul class="news-list" id="newsList">
						<li>
							<div>
								<span class="news-title">시스템 인사이트: BTC 장중 변동성 12% 감소, 포지션 유지 권장</span>
								<span class="news-meta">8분 전 · 시스템 분석</span>
							</div>
							<span class="news-tag positive">안정</span>
						</li>
						<li>
							<div>
								<span class="news-title">국내 반도체 섹터 외국인 순매수 확대</span>
								<span class="news-meta">32분 전 · 국내 증시</span>
							</div>
							<span class="news-tag neutral">중립</span>
						</li>
						<li>
							<div>
								<span class="news-title">예측 모델 업데이트, 평균 정확도 1.8% 상승</span>
								<span class="news-meta">1시간 전 · 시스템공지</span>
							</div>
							<span class="news-tag positive">호재</span>
						</li>
					</ul>
				</div>
			</div>
		</section>
	</div>

	<nav class="mobile-bottom-nav mobile-only">
		<a href="index.html" class="mobile-nav-item">
			<i class="fas fa-home"></i>
			<span>홈</span>
		</a>
		<a href="charts.html" class="mobile-nav-item">
			<i class="fas fa-chart-area"></i>
			<span>차트</span>
		</a>
		<a href="prediction.html" class="mobile-nav-item">
			<i class="fas fa-magic"></i>
			<span>예측</span>
		</a>
		<a href="my-predictions.html" class="mobile-nav-item active">
			<i class="fas fa-user-chart"></i>
			<span>내 예측</span>
		</a>
	</nav>

	<div id="predictionToast" class="home-toast"></div>

	<script>
		const state = {
			predictions: [],
			filtered: [],
			currentFilters: {
				status: 'all',
				period: 'all',
				symbol: 'all'
			}
		};

		document.addEventListener('DOMContentLoaded', () => {
			const refreshBtn = document.getElementById('refreshPredictionsBtn');
			const testDataBtn = document.getElementById('testDataBtn');
			const emptyStateAction = document.getElementById('emptyStateAction');
			const newPredictionBtn = document.getElementById('newPredictionBtn');
			const quickForm = document.getElementById('quickPredictionForm');

			attachFilterListeners();

			refreshBtn?.addEventListener('click', loadUserPredictions);
			testDataBtn?.addEventListener('click', loadTestData);
			emptyStateAction?.addEventListener('click', handleCreatePrediction);
			newPredictionBtn?.addEventListener('click', handleCreatePrediction);

			quickForm?.addEventListener('submit', event => {
				event.preventDefault();
				handleCreatePrediction();
			});

			document.querySelectorAll('.direction-btn').forEach(btn => {
				btn.addEventListener('click', () => {
					document.querySelectorAll('.direction-btn').forEach(b => b.classList.remove('active'));
					btn.classList.add('active');
				});
			});

			loadUserPredictions();
		});

		function attachFilterListeners() {
			const statusFilter = document.getElementById('statusFilter');
			const periodFilter = document.getElementById('periodFilter');
			const symbolFilter = document.getElementById('symbolFilter');

			statusFilter?.addEventListener('change', event => {
				state.currentFilters.status = event.target.value;
				applyFilters();
			});

			periodFilter?.addEventListener('change', event => {
				state.currentFilters.period = event.target.value;
				applyFilters();
			});

			symbolFilter?.addEventListener('change', event => {
				state.currentFilters.symbol = event.target.value;
				applyFilters();
			});
		}

		async function loadUserPredictions() {
			showLoadingState();

			try {
				const response = await fetch('/api/charts/predictions/all/');
				if (!response.ok) {
					throw new Error(`API error: ${response.status}`);
				}

				const payload = await response.json();
				const allPredictions = payload.predictions || [];
				state.predictions = allPredictions.filter(item => item.user?.username?.toLowerCase() === 'anonymous');
			} catch (error) {
				console.warn('Falling back to local predictions:', error.message);
				const stored = localStorage.getItem('userPredictions');
				state.predictions = stored ? JSON.parse(stored) : [];
			}

			hideLoadingState();
			applyFilters();
			renderStats();
		}

		function loadTestData() {
			state.predictions = [
				{
					id: 'demo-1',
					symbol: 'BTC',
					stock_name: 'Bitcoin Spot',
					market_type: 'crypto',
					current_price: 42850,
					predicted_price: 45200,
					prediction_date: '2025-10-07T09:15:00Z',
					target_date: '2025-10-14T09:15:00Z',
					duration_days: 7,
					status: 'pending',
					created_at: '2025-10-07T09:15:00Z',
					user: { username: 'anonymous' }
				},
				{
					id: 'demo-2',
					symbol: 'KOSPI200',
					stock_name: 'KOSPI 200',
					market_type: 'kr_stock',
					current_price: 312.4,
					predicted_price: 318.7,
					prediction_date: '2025-09-28T02:00:00Z',
					target_date: '2025-10-05T02:00:00Z',
					duration_days: 7,
					status: 'completed',
					profit_rate: 2.1,
					created_at: '2025-09-28T02:00:00Z',
					user: { username: 'anonymous' }
				},
				{
					id: 'demo-3',
					symbol: 'AAPL',
					stock_name: 'Apple Inc.',
					market_type: 'us_stock',
					current_price: 189.2,
					predicted_price: 182.6,
					prediction_date: '2025-09-20T13:40:00Z',
					target_date: '2025-09-27T13:40:00Z',
					duration_days: 7,
					status: 'completed',
					profit_rate: -3.4,
					created_at: '2025-09-20T13:40:00Z',
					user: { username: 'anonymous' }
				}
			];

			hideLoadingState();
			applyFilters();
			renderStats();
			showToast('테스트 데이터가 로드되었습니다.');
		}

		function applyFilters() {
			const { status, period, symbol } = state.currentFilters;
			const now = new Date();

			state.filtered = state.predictions.filter(prediction => {
				if (status !== 'all' && prediction.status !== status) {
					return false;
				}

				if (symbol !== 'all' && prediction.market_type !== symbol) {
					return false;
				}

				if (period !== 'all') {
					const target = new Date(prediction.target_date || prediction.prediction_date);
					const diff = (now - target) / (1000 * 60 * 60 * 24);

					if (period === 'week' && diff > 7) return false;
					if (period === 'month' && diff > 30) return false;
					if (period === 'quarter' && diff > 90) return false;
				}

				return true;
			});

			renderPredictions();
		}

		function renderStats() {
			const container = document.getElementById('statsOverview');

			if (!container) return;

			if (state.predictions.length === 0) {
				container.innerHTML = `
					<div class="metric-card primary">
						<div class="metric-label">총 예측 수</div>
						<div class="metric-value">0</div>
						<div class="metric-sub">첫 예측을 등록해보세요.</div>
					</div>
					<div class="metric-card">
						<div class="metric-label">정확도</div>
						<div class="metric-value">0%</div>
						<div class="metric-sub">완료된 예측이 필요합니다.</div>
					</div>
					<div class="metric-card">
						<div class="metric-label">누적 수익률</div>
						<div class="metric-value">0%</div>
						<div class="metric-sub">데이터가 수집되면 표시됩니다.</div>
					</div>
					<div class="metric-card">
						<div class="metric-label">연속 성공</div>
						<div class="metric-value">0</div>
						<div class="metric-sub">성공 기록을 시작해보세요.</div>
					</div>
				`;
				return;
			}

			const completed = state.predictions.filter(p => p.status === 'completed');
			const successful = completed.filter(p => (p.profit_rate || 0) > 0);
			const totalReturn = completed.reduce((sum, p) => sum + (parseFloat(p.profit_rate) || 0), 0);

			container.innerHTML = `
				<div class="metric-card primary">
					<div class="metric-label">총 예측 수</div>
					<div class="metric-value">${state.predictions.length}</div>
					<div class="metric-change ${state.filtered.length >= state.predictions.length ? 'positive' : ''}">
						실시간 동기화 완료
					</div>
				</div>
				<div class="metric-card">
					<div class="metric-label">정확도</div>
					<div class="metric-value">${completed.length ? ((successful.length / completed.length) * 100).toFixed(1) : '0.0'}%</div>
					<div class="metric-sub">완료된 예측 기준</div>
				</div>
				<div class="metric-card">
					<div class="metric-label">누적 수익률</div>
					<div class="metric-value ${totalReturn >= 0 ? 'positive-text' : 'negative-text'}">${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(1)}%</div>
					<div class="metric-sub">완료된 예측 합산</div>
				</div>
				<div class="metric-card">
					<div class="metric-label">연속 성공</div>
					<div class="metric-value">${calculateSuccessStreak()}</div>
					<div class="metric-sub">최근 제출 기준</div>
				</div>
			`;
		}

		function calculateSuccessStreak() {
			const completed = [...state.predictions]
				.filter(p => p.status === 'completed')
				.sort((a, b) => new Date(b.target_date || b.created_at) - new Date(a.target_date || a.created_at));

			let streak = 0;
			for (const prediction of completed) {
				if ((prediction.profit_rate || 0) > 0) {
					streak += 1;
				} else {
					break;
				}
			}
			return streak;
		}

		function renderPredictions() {
			const tableBody = document.getElementById('predictionsTableBody');
			const emptyState = document.getElementById('emptyState');

			if (!tableBody) return;

			if (state.filtered.length === 0) {
				tableBody.innerHTML = '';
				emptyState?.classList.remove('hidden');
				return;
			}

			emptyState?.classList.add('hidden');
			const rows = state.filtered.map(renderPredictionRow).join('');
			tableBody.innerHTML = rows;
		}

		function renderPredictionRow(prediction) {
			const predictionDate = new Date(prediction.prediction_date);
			const targetDate = new Date(prediction.target_date || prediction.prediction_date);
			const now = new Date();
			const priceChange = calculatePriceChange(prediction);

			const directionClass = priceChange >= 0 ? 'positive-text' : 'negative-text';
			const statusConfig = resolveStatusConfig(prediction, now >= targetDate);

			return `
				<tr>
					<td>
						<div class="table-symbol">
							<span class="symbol-tag">${prediction.symbol}</span>
							<span class="symbol-meta">${prediction.stock_name || '&middot;'}</span>
						</div>
					</td>
					<td>
						<div class="table-col">
							<strong>${formatDate(predictionDate)}</strong>
							<span>${prediction.user?.username || 'anonymous'}</span>
						</div>
					</td>
					<td class="numeric">${formatCurrency(prediction.current_price)}</td>
					<td class="numeric">${formatCurrency(prediction.predicted_price)}</td>
					<td class="numeric ${directionClass}">
						${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}%
						${prediction.accuracy_percentage ? `<span class="subtext">정확도 ${parseFloat(prediction.accuracy_percentage).toFixed(1)}%</span>` : ''}
					</td>
					<td>
						<div class="table-col">
							<strong>${formatDate(targetDate)}</strong>
							${prediction.status === 'pending' && now < targetDate ? `<span class="subtext">D-${Math.max(0, Math.ceil((targetDate - now) / 86400000))}</span>` : ''}
						</div>
					</td>
					<td>
						<span class="status-chip ${statusConfig.class}">
							<i class="fas ${statusConfig.icon}"></i>
							${statusConfig.label}
						</span>
					</td>
					<td>
						<div class="table-actions">
							<button class="ghost-btn small" data-action="view" data-id="${prediction.id}">
								자세히
							</button>
							${prediction.status === 'pending' ? `<button class="ghost-btn small" data-action="cancel" data-id="${prediction.id}">취소</button>` : ''}
						</div>
					</td>
				</tr>
			`;
		}

		function resolveStatusConfig(prediction, isCompleted) {
			if (prediction.status === 'cancelled') {
				return { label: '취소됨', class: 'neutral', icon: 'fa-ban' };
			}

			if (prediction.status === 'completed' || isCompleted) {
				const profit = prediction.profit_rate || calculatePriceChange(prediction);
				return profit >= 0
					? { label: '성공', class: 'success', icon: 'fa-arrow-trend-up' }
					: { label: '완료', class: 'warning', icon: 'fa-arrow-trend-down' };
			}

			return { label: '진행중', class: 'info', icon: 'fa-clock' };
		}

		function calculatePriceChange(prediction) {
			const base = parseFloat(prediction.current_price) || 0;
			const target = parseFloat(prediction.predicted_price) || base;

			if (!base) return 0;
			return ((target - base) / base) * 100;
		}

		function formatCurrency(value) {
			const number = parseFloat(value) || 0;
			if (Math.abs(number) >= 100000) {
				return `$${number.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
			}
			return `$${number.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
		}

		function formatDate(date) {
			if (!(date instanceof Date) || isNaN(date)) {
				return '-';
			}
			return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
		}

		function showLoadingState() {
			const loading = document.getElementById('predictionsLoading');
			const emptyState = document.getElementById('emptyState');
			const tableBody = document.getElementById('predictionsTableBody');

			loading?.classList.remove('hidden');
			emptyState?.classList.add('hidden');
			if (tableBody) tableBody.innerHTML = '';
		}

		function hideLoadingState() {
			const loading = document.getElementById('predictionsLoading');
			loading?.classList.add('hidden');
		}

		function handleCreatePrediction() {
			showToast('예측 작성 페이지를 준비 중입니다. 곧 제공될 예정입니다.');
		}

		function showToast(message, type = 'success') {
			const toast = document.getElementById('predictionToast');
			if (!toast) return;

			toast.textContent = message;
			toast.className = `home-toast visible ${type}`;

			clearTimeout(showToast.timer);
			showToast.timer = setTimeout(() => {
				toast.classList.remove('visible');
			}, 3200);
		}

		document.addEventListener('click', event => {
			const target = event.target.closest('[data-action]');
			if (!target) return;

			const id = target.getAttribute('data-id');
			const action = target.getAttribute('data-action');

			if (action === 'view') {
				showToast('상세 분석 기능은 준비 중입니다.', 'info');
			}

			if (action === 'cancel') {
				const prediction = state.predictions.find(item => String(item.id) === String(id));
				if (!prediction) return;

				prediction.status = 'cancelled';
				localStorage.setItem('userPredictions', JSON.stringify(state.predictions));
				applyFilters();
				renderStats();
				showToast('예측이 취소되었습니다.', 'success');
			}
		});
	</script>
</body>
</html>

