<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #testChart {
            width: 800px;
            height: 400px;
            border: 1px solid #ccc;
            margin: 20px 0;
        }

        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
        }
    </style>
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
</head>

<body>
    <h1>Chart Test</h1>
    <div id="testChart"></div>
    <div class="log" id="log"></div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000/api';

        function log(message) {
            console.log(message);
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function testChart() {
            try {
                log('Starting chart test...');

                const chartElement = document.getElementById('testChart');

                // Create chart
                const chart = LightweightCharts.createChart(chartElement, {
                    width: 800,
                    height: 400,
                    layout: {
                        backgroundColor: '#ffffff',
                        textColor: '#333',
                    },
                    grid: {
                        vertLines: { color: '#f0f0f0' },
                        horzLines: { color: '#f0f0f0' },
                    },
                    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                    rightPriceScale: { borderColor: '#cccccc' },
                    timeScale: { borderColor: '#cccccc' },
                });

                log('Chart created successfully');

                // Test API endpoints
                const apiSources = [
                    { name: 'Bitcoin Historical', url: `${API_BASE_URL}/market-data/historical/bitcoin/?market=crypto` },
                    { name: 'CoinGecko Historical', url: `${API_BASE_URL}/market-data/coingecko/bitcoin/` },
                    { name: 'Bitcoin Crypto API', url: `${API_BASE_URL}/market-data/crypto/bitcoin/` }
                ];

                let data = null;
                let usedSource = null;

                for (const source of apiSources) {
                    try {
                        log(`Testing ${source.name}...`);
                        const response = await fetch(source.url);
                        log(`${source.name} response status: ${response.status}`);

                        if (response.ok) {
                            const apiData = await response.json();
                            log(`${source.name} response data: ${JSON.stringify(apiData).substring(0, 200)}...`);

                            if (apiData && (Array.isArray(apiData) || apiData.data)) {
                                data = Array.isArray(apiData) ? apiData : apiData.data;
                                usedSource = source.name;
                                log(`Successfully loaded data from ${source.name}, data points: ${data.length}`);
                                break;
                            }
                        } else {
                            const errorText = await response.text();
                            log(`${source.name} error: ${errorText}`);
                        }
                    } catch (error) {
                        log(`${source.name} failed: ${error.message}`);
                    }
                }

                if (!data) {
                    log('ERROR: No data loaded from any API');
                    return;
                }

                // Format data for chart
                log('Formatting data for chart...');
                const formattedData = data.map((item, index) => {
                    const time = item.date || item.time || item.datetime || item.timestamp;
                    const value = parseFloat(
                        item.close || item.price || item.value || item.c ||
                        item.Close || item.Price || item.Value || item.adjusted_close
                    );

                    let processedTime = time;
                    if (typeof time === 'string') {
                        const parsed = new Date(time);
                        if (!isNaN(parsed.getTime())) {
                            processedTime = Math.floor(parsed.getTime() / 1000);
                        }
                    } else if (typeof time === 'number' && time > 1000000000000) {
                        processedTime = Math.floor(time / 1000);
                    }

                    if (index < 3) {
                        log(`Data point ${index}: time=${processedTime}, value=${value}`);
                    }

                    return { time: processedTime, value };
                }).filter((item) => {
                    const isValid = item.time && !isNaN(item.value) && item.value > 0;
                    return isValid;
                });

                log(`Formatted ${formattedData.length} data points`);

                if (formattedData.length === 0) {
                    log('ERROR: No valid data points after formatting');
                    return;
                }

                // Add to chart
                log('Adding line series to chart...');
                const lineSeries = chart.addLineSeries({
                    color: '#2962FF',
                    lineWidth: 2,
                });

                lineSeries.setData(formattedData);
                chart.timeScale().fitContent();

                log(`Chart loaded successfully with ${formattedData.length} data points from ${usedSource}`);

            } catch (error) {
                log(`ERROR: ${error.message}`);
                log(`Stack: ${error.stack}`);
            }
        }

        // Start test when page loads
        window.addEventListener('load', testChart);
    </script>
</body>

</html>